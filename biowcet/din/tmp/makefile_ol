ARMCPU   = cortex-m3
STM32MCU = STM32F103x6
AUX_FILES= ./aux_files
LINKERSCRIPT = $(AUX_FILES)/scripts/STM32F103X6_FLASH.ld

# Project directories
SRCDIR   = src
INCDIR   = $(AUX_FILES)/inc
ASMDIR   = $(AUX_FILES)/startup
CMSISDIR = $(AUX_FILES)/cmsis
BUILDDIR = ./build

# Toolchain binaries
CC       =arm-none-eabi-gcc
AS       =arm-none-eabi-as
LD       =arm-none-eabi-ld
OBJCOPY  =arm-none-eabi-objcopy
SIZE     =arm-none-eabi-size
OBJDUMP  =arm-none-eabi-objdump
RM       =rm -rf
DBG      =gdb-multiarch
OCD	     =openocd

# Output file name
APP_NAME = main

# Source files 
SRC := $(wildcard $(SRCDIR)/*.c)
ASM := $(wildcard $(ASMDIR)/*.s)

# Header files
INCLUDE  = -I$(INCDIR) -I$(CMSISDIR)

# Compiler flags
CFLAGS  = -O0 -std=c99 -mthumb -mcpu=$(ARMCPU) -D$(STM32MCU) -Wa,-ahlms=$(addprefix $(BUILDDIR)/,$(notdir $(<:.c=.lst))) $(INCLUDE)
CFLAGS	+= -g3 # Enable debug symbols

# Linker flags
LDFLAGS = -O0 -T$(LINKERSCRIPT) -mthumb -mcpu=$(ARMCPU) --specs=nosys.specs --specs=nano.specs -Wa,-ahlms=$(addprefix $(BUILDDIR)/,$(notdir $(<:.c=.lst))) $(INCLUDE)

# Objects to build
OBJ = $(addprefix $(BUILDDIR)/,$(notdir $(SRC:.c=.o)))  $(addprefix $(BUILDDIR)/,$(notdir $(ASM:.s=.o)))

.DEFAULT_GOAL = all

DFLAGS = -DSIZE=150

.PHONY: clean

all: $(BUILDDIR)/$(APP_NAME).bin
	mkff $(BUILDDIR)/$(APP_NAME).elf > $(BUILDDIR)/$(APP_NAME).ff

clean:
	$(RM) $(BUILDDIR)

$(BUILDDIR)/%.o: $(SRCDIR)/%.c
	@mkdir -p $(dir $@)
	$(CC) $(DFLAGS) $(CFLAGS) -c $< -o $@

$(BUILDDIR)/%.o: $(ASMDIR)/%.s
	@mkdir -p $(dir $@)
	$(AS) $(ASFLAGS) -o $@ $<

# Link binaries


$(BUILDDIR)/$(APP_NAME).elf: $(OBJ)
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) $(OBJ) $(LDFLAGS) -o $(BUILDDIR)/$(APP_NAME).elf
	$(OBJDUMP) -D -S $(BUILDDIR)/$(APP_NAME).elf > $(BUILDDIR)/$(APP_NAME).lst
	$(SIZE) $(BUILDDIR)/$(APP_NAME).elf






$(BUILDDIR)/$(APP_NAME).bin: $(BUILDDIR)/$(APP_NAME).elf
	$(OBJCOPY) -R .stack -O binary $(BUILDDIR)/$(APP_NAME).elf $(BUILDDIR)/$(APP_NAME).bin

flash: $(BUILDDIR)/$(APP_NAME).bin
	st-flash write $(BUILDDIR)/$(APP_NAME).bin 0x8000000

debug: $(BUILDDIR)/$(APP_NAME).elf
	$(OCD) -f stlink_bluepill.cfg &
	$(DBG) -x hwdebug.py $(BUILDDIR)/$(APP_NAME).elf
	pkill openocd

test: flash debug
	pkill openocd